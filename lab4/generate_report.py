"""
–ú–æ–¥—É–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ Markdown –æ—Ç—á–µ—Ç–∞ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
"""
import time
import logging
from pathlib import Path
from typing import Dict, List, Tuple, Any, Optional
from datetime import datetime

from models import Portfolio, Scenario
from solver import DynamicProgrammingSolver
from data_loader import (
    load_from_excel, validate_scenarios, load_commissions,
    initialize_portfolio
)
from path_recovery import monte_carlo_simulation, recover_path
from visualizers import (
    visualize_initial_portfolio, visualize_scenarios, visualize_dp_process,
    visualize_optimal_actions, visualize_portfolio_evolution, visualize_monte_carlo,
    visualize_sensitivity, visualize_criteria_comparison, visualize_3d_value_function,
    visualize_decision_tree
)
from data_exporter import export_all_data
from sensitivity_analysis import run_full_sensitivity_analysis
from criteria_comparison import compare_all_criteria
from constants import (
    INITIAL_CB1, INITIAL_CB2, INITIAL_DEP, INITIAL_CASH,
    USE_COMMISSIONS, USE_MIN_CONSTRAINTS, NUM_STAGES,
    MIN_CB1, MIN_CB2, MIN_DEP
)

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def create_report_structure() -> None:
    """
    –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –¥–ª—è –æ—Ç—á–µ—Ç–∞
    """
    try:
        Path('output').mkdir(exist_ok=True)
        Path('output/diagrams').mkdir(exist_ok=True)
        Path('output/data').mkdir(exist_ok=True)
        logger.info("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ —Å–æ–∑–¥–∞–Ω–∞")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫: {e}")
        raise


def generate_all_visualizations(solver: DynamicProgrammingSolver,
                               initial_portfolio: Portfolio,
                               scenarios: Dict[int, List[Scenario]],
                               commissions: Dict[str, float],
                               path: List[Portfolio],
                               actions: List[Tuple[float, float, float]],
                               mc_results: Dict[str, Any],
                               sensitivity_results: Dict[str, List[Dict[str, float]]],
                               criteria_results: Dict[str, float],
                               timing_data: Dict[int, float] = None) -> Dict[str, str]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    
    Args:
        solver: –†–µ—à–∞—Ç–µ–ª—å —Å —Ä–µ—à–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ–π
        initial_portfolio: –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å
        scenarios: –°—Ü–µ–Ω–∞—Ä–∏–∏
        commissions: –ö–æ–º–∏—Å—Å–∏–∏
        path: –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
        actions: –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        mc_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Monte Carlo
        sensitivity_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        criteria_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        timing_data: –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –ø—É—Ç—è–º–∏ –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
    """
    logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π...")
    diagram_paths = {}
    
    try:
        # 1. –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å
        diagram_paths['initial_portfolio'] = visualize_initial_portfolio(
            initial_portfolio, commissions
        )
        
        # 2. –°—Ü–µ–Ω–∞—Ä–∏–∏
        heatmap_path, tree_path = visualize_scenarios(scenarios)
        diagram_paths['scenarios_heatmap'] = heatmap_path
        diagram_paths['scenarios_tree'] = tree_path
        
        # 3. –ü—Ä–æ—Ü–µ—Å—Å DP
        diagram_paths['dp_process'] = visualize_dp_process(solver, timing_data)
        
        # 4. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        expected_values = [solver.value_function[1].get(
            solver._find_closest_state(initial_portfolio, 1), 0.0
        )] if 1 in solver.value_function else None
        diagram_paths['optimal_actions'] = visualize_optimal_actions(actions, expected_values)
        
        # 5. –≠–≤–æ–ª—é—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
        diagram_paths['portfolio_evolution'] = visualize_portfolio_evolution(path)
        
        # 6. Monte Carlo
        dist_path, cdf_path = visualize_monte_carlo(mc_results)
        diagram_paths['mc_distribution'] = dist_path
        diagram_paths['mc_cdf'] = cdf_path
        
        # 7. –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        if sensitivity_results:
            prob_path, comm_path = visualize_sensitivity(sensitivity_results)
            diagram_paths['sensitivity_prob'] = prob_path
            diagram_paths['sensitivity_comm'] = comm_path
        
        # 8. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        if criteria_results:
            diagram_paths['criteria_comparison'] = visualize_criteria_comparison(criteria_results)
        
        # 9. 3D —Ñ—É–Ω–∫—Ü–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏
        diagram_paths['3d_value'] = visualize_3d_value_function(solver)
        
        # 10. –î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π
        diagram_paths['decision_tree'] = visualize_decision_tree(solver)
        
        logger.info(f"–í—Å–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã ({len(diagram_paths)} —Ñ–∞–π–ª–æ–≤)")
        return diagram_paths
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π: {e}")
        raise


def generate_markdown_report(solver: DynamicProgrammingSolver,
                            initial_portfolio: Portfolio,
                            scenarios: Dict[int, List[Scenario]],
                            commissions: Dict[str, float],
                            path: List[Portfolio],
                            actions: List[Tuple[float, float, float]],
                            total_value: float,
                            mc_results: Dict[str, Any],
                            sensitivity_results: Dict[str, List[Dict[str, float]]],
                            criteria_results: Dict[str, float],
                            diagram_paths: Dict[str, str],
                            timing_data: Dict[int, float] = None) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π Markdown –æ—Ç—á–µ—Ç
    
    Args:
        solver: –†–µ—à–∞—Ç–µ–ª—å
        initial_portfolio: –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å
        scenarios: –°—Ü–µ–Ω–∞—Ä–∏–∏
        commissions: –ö–æ–º–∏—Å—Å–∏–∏
        path: –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
        actions: –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        total_value: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥
        mc_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Monte Carlo
        sensitivity_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        criteria_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        diagram_paths: –ü—É—Ç–∏ –∫ –¥–∏–∞–≥—Ä–∞–º–º–∞–º
        timing_data: –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        
    Returns:
        –ü—É—Ç—å –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É –æ—Ç—á–µ—Ç—É
    """
    logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Markdown –æ—Ç—á–µ—Ç–∞...")
    
    filepath = Path('output') / 'report.md'
    
    try:
        report = f"""# –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞—á–∏)
3. [–≠—Ç–∞–ø 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è](#—ç—Ç–∞–ø-1-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
4. [–≠—Ç–∞–ø 2: –°—Ü–µ–Ω–∞—Ä–∏–∏](#—ç—Ç–∞–ø-2-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
5. [–≠—Ç–∞–ø 3: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ](#—ç—Ç–∞–ø-3-–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
6. [–≠—Ç–∞–ø 4: –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#—ç—Ç–∞–ø-4-–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
7. [–≠—Ç–∞–ø 5: –≠–≤–æ–ª—é—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è](#—ç—Ç–∞–ø-5-—ç–≤–æ–ª—é—Ü–∏—è-–ø–æ—Ä—Ç—Ñ–µ–ª—è)
8. [–≠—Ç–∞–ø 6: Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è](#—ç—Ç–∞–ø-6-monte-carlo-–≤–∞–ª–∏–¥–∞—Ü–∏—è)
9. [–≠—Ç–∞–ø 7: –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#—ç—Ç–∞–ø-7-–∞–Ω–∞–ª–∏–∑-—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
10. [–≠—Ç–∞–ø 8: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤](#—ç—Ç–∞–ø-8-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ-–∫—Ä–∏—Ç–µ—Ä–∏–µ–≤)
11. [–≠—Ç–∞–ø 9: 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è](#—ç—Ç–∞–ø-9-3d-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
12. [–≠—Ç–∞–ø 10: –î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π](#—ç—Ç–∞–ø-10-–¥–µ—Ä–µ–≤–æ-—Ä–µ—à–µ–Ω–∏–π)
13. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)
14. [–ö–æ–¥ —Ä–µ—à–µ–Ω–∏—è](#–∫–æ–¥-—Ä–µ—à–µ–Ω–∏—è)

---

## –í–≤–µ–¥–µ–Ω–∏–µ

–î–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º –º–µ—Ç–æ–¥–æ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–¥–∞—á–∞ –∏–º–µ–µ—Ç —Å—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ç–∞–∫ –∫–∞–∫ –±—É–¥—É—â–∏–µ –¥–æ—Ö–æ–¥—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞–∑–≤–∏—Ç–∏—è —Ä—ã–Ω–∫–∞.

**–¶–µ–ª—å —Ä–∞–±–æ—Ç—ã:** –ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º, –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É—é—â—É—é –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥ –∑–∞ 3 —ç—Ç–∞–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

**–ú–µ—Ç–æ–¥ —Ä–µ—à–µ–Ω–∏—è:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫—Ä–∏—Ç–µ—Ä–∏–µ–º –ë–∞–π–µ—Å–∞ (–º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ—Ö–æ–¥–∞).

---

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

### 2.1 –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏

–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ—Ä—Ç—Ñ–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö –≤–∏–¥–æ–≤ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥ (–¶–ë1 –∏ –¶–ë2) –∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø—É—Ç–µ–º –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–∞–∂–∏ –∞–∫—Ç–∏–≤–æ–≤ –ø–∞–∫–µ—Ç–∞–º–∏ (25% –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–º–∞).

**–ü–µ—Ä–∏–æ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:** 3 —ç—Ç–∞–ø–∞  
**–ö—Ä–∏—Ç–µ—Ä–∏–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—Å—Ç–∏:** –ú–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞ (–∫—Ä–∏—Ç–µ—Ä–∏–π –ë–∞–π–µ—Å–∞)  
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –±—Ä–æ–∫–µ—Ä–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –∞–∫—Ç–∏–≤–æ–≤

#### –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è:**
$$s_t = (s_{{CB1}}, s_{{CB2}}, s_{{Dep}}, s_{{cash}}) \\in \\mathbb{{R}}^4_+$$

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
$$u_t = (\\Delta_{{CB1}}, \\Delta_{{CB2}}, \\Delta_{{Dep}}) \\in \\mathbb{{R}}^3$$

**–¶–µ–ª–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–∫—Ä–∏—Ç–µ—Ä–∏–π –ë–∞–π–µ—Å–∞):**
$$\\max \\mathbb{{E}}[J_1(s_1)] = \\max \\mathbb{{E}}\\left[\\sum_{{t=1}}^{{T}} r_t(s_t, u_t)\\right]$$

–≥–¥–µ $r_t$ - –¥–æ—Ö–æ–¥ –Ω–∞ —ç—Ç–∞–ø–µ $t$, $T=3$ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤.

### 2.2 –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¶–ë1 | {INITIAL_CB1:.2f} –¥.–µ. |
| –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¶–ë2 | {INITIAL_CB2:.2f} –¥.–µ. |
| –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –î–µ–ø–æ–∑–∏—Ç–æ–≤ | {INITIAL_DEP:.2f} –¥.–µ. |
| –ù–∞—á–∞–ª—å–Ω–∞—è –∫–∞—Å—Å–∞ | {INITIAL_CASH:.2f} –¥.–µ. |
| **–ò—Ç–æ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª** | **{initial_portfolio.total_value():.2f} –¥.–µ.** |
| –ö–æ–º–∏—Å—Å–∏—è –¶–ë1 | {commissions['cb1']:.1%} {'(–≤–∫–ª—é—á–µ–Ω–∞)' if USE_COMMISSIONS else '(–≤—ã–∫–ª—é—á–µ–Ω–∞)'} |
| –ö–æ–º–∏—Å—Å–∏—è –¶–ë2 | {commissions['cb2']:.1%} {'(–≤–∫–ª—é—á–µ–Ω–∞)' if USE_COMMISSIONS else '(–≤—ã–∫–ª—é—á–µ–Ω–∞)'} |
| –ö–æ–º–∏—Å—Å–∏—è –î–µ–ø–æ–∑–∏—Ç–æ–≤ | {commissions['dep']:.1%} {'(–≤–∫–ª—é—á–µ–Ω–∞)' if USE_COMMISSIONS else '(–≤—ã–∫–ª—é—á–µ–Ω–∞)'} |
| –ú–∏–Ω–∏–º—É–º –¶–ë1 | {MIN_CB1:.2f} –¥.–µ. {'(–≤–∫–ª—é—á–µ–Ω)' if USE_MIN_CONSTRAINTS else '(–≤—ã–∫–ª—é—á–µ–Ω)'} |
| –ú–∏–Ω–∏–º—É–º –¶–ë2 | {MIN_CB2:.2f} –¥.–µ. {'(–≤–∫–ª—é—á–µ–Ω)' if USE_MIN_CONSTRAINTS else '(–≤—ã–∫–ª—é—á–µ–Ω)'} |
| –ú–∏–Ω–∏–º—É–º –î–µ–ø–æ–∑–∏—Ç–æ–≤ | {MIN_DEP:.2f} –¥.–µ. {'(–≤–∫–ª—é—á–µ–Ω)' if USE_MIN_CONSTRAINTS else '(–≤—ã–∫–ª—é—á–µ–Ω)'} |

### 2.3 –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è

–ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–æ–∑–º–æ–∂–Ω—ã —Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è: –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∏ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ.

"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        report += "#### –≠–¢–ê–ü 1 (–ü–µ—Ä–∏–æ–¥ 0‚Üí1):\n\n"
        report += "| –°–∏—Ç—É–∞—Ü–∏—è | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –¶–ë1 | –¶–ë2 | –î–µ–ø. |\n"
        report += "|----------|-------------|-----|-----|------|\n"
        for scenario in scenarios[1]:
            report += f"| {scenario.situation} | {scenario.probability:.2f} | {scenario.cb1_multiplier:.2f} | {scenario.cb2_multiplier:.2f} | {scenario.dep_multiplier:.2f} |\n"
        
        report += "\n#### –≠–¢–ê–ü 2 (–ü–µ—Ä–∏–æ–¥ 1‚Üí2):\n\n"
        report += "| –°–∏—Ç—É–∞—Ü–∏—è | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –¶–ë1 | –¶–ë2 | –î–µ–ø. |\n"
        report += "|----------|-------------|-----|-----|------|\n"
        for scenario in scenarios[2]:
            report += f"| {scenario.situation} | {scenario.probability:.2f} | {scenario.cb1_multiplier:.2f} | {scenario.cb2_multiplier:.2f} | {scenario.dep_multiplier:.2f} |\n"
        
        report += "\n#### –≠–¢–ê–ü 3 (–ü–µ—Ä–∏–æ–¥ 2‚Üí3):\n\n"
        report += "| –°–∏—Ç—É–∞—Ü–∏—è | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –¶–ë1 | –¶–ë2 | –î–µ–ø. |\n"
        report += "|----------|-------------|-----|-----|------|\n"
        for scenario in scenarios[3]:
            report += f"| {scenario.situation} | {scenario.probability:.2f} | {scenario.cb1_multiplier:.2f} | {scenario.cb2_multiplier:.2f} | {scenario.dep_multiplier:.2f} |\n"
        
        # –ü—Ä–æ–¥–æ–ª–∂–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞...
        report += f"""

---

## –≠—Ç–∞–ø 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### 1.1 –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è

–ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
- **–¶–ë1:** {initial_portfolio.cb1:.2f} –¥.–µ. ({initial_portfolio.cb1/initial_portfolio.total_value()*100:.1f}%)
- **–¶–ë2:** {initial_portfolio.cb2:.2f} –¥.–µ. ({initial_portfolio.cb2/initial_portfolio.total_value()*100:.1f}%)
- **–î–µ–ø–æ–∑–∏—Ç—ã:** {initial_portfolio.dep:.2f} –¥.–µ. ({initial_portfolio.dep/initial_portfolio.total_value()*100:.1f}%)
- **–ö–∞—Å—Å–∞:** {initial_portfolio.cash:.2f} –¥.–µ. ({initial_portfolio.cash/initial_portfolio.total_value()*100:.1f}%)
- **–ò—Ç–æ–≥–æ:** {initial_portfolio.total_value():.2f} –¥.–µ.

![–ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å](diagrams/01_initial_portfolio.png)

*–†–∏—Å. 1.1 - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è*

### 1.2 –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—á–∏

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—á–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –≤—ã—à–µ.

---

## –≠—Ç–∞–ø 2: –°—Ü–µ–Ω–∞—Ä–∏–∏

### 2.1 –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

![–ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤](diagrams/02_scenarios_matrix.png)

*–†–∏—Å. 2.1 - –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π*

### 2.2 –î–µ—Ä–µ–≤–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

![–î–µ—Ä–µ–≤–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤](diagrams/02_scenario_tree.png)

*–†–∏—Å. 2.2 - –ì—Ä–∞—Ñ –¥–µ—Ä–µ–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤*

### 2.3 –ê–Ω–∞–ª–∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

–ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏. –°—É–º–º–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Ä–∞–≤–Ω–∞ 1.0, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏.

---

## –≠—Ç–∞–ø 3: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3.1 –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å

#### –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ë–µ–ª–ª–º–∞–Ω–∞

–û—Å–Ω–æ–≤–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è:

$$J_t(s_t) = \\max_{{u_t \\in U_t(s_t)}} \\mathbb{{E}}_{{\\omega_t}}[J_{{t+1}}(s_{{t+1}}(s_t, \\omega_t, u_t))]$$

–ì—Ä–∞–Ω–∏—á–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ:

$$J_T(s_T) = V(s_T)$$

–≥–¥–µ $V(s_T)$ - –ø–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ $s_T$.

–≥–¥–µ:
- $J_t(s_t)$ - —Ñ—É–Ω–∫—Ü–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è $s_t$ –Ω–∞ —ç—Ç–∞–ø–µ $t$
- $u_t$ - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–µ–π—Å—Ç–≤–∏–µ) –Ω–∞ —ç—Ç–∞–ø–µ $t$
- $\\omega_t$ - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–∞ —ç—Ç–∞–ø–µ $t$
- $\\mathbb{{E}}_{{\\omega_t}}[\\cdot]$ - –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º
- $U_t(s_t)$ - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è $s_t$

#### –£—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è $u_t = (\\Delta_{{CB1}}, \\Delta_{{CB2}}, \\Delta_{{Dep}})$ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è $\\omega_t$:

$$s_{{t+1}} = f(s_t, u_t, \\omega_t)$$

–≥–¥–µ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤–∫–ª—é—á–∞–µ—Ç:

1. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
   $$s'_t = s_t + u_t - C(u_t)$$
   
   –≥–¥–µ $C(u_t)$ - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π:
   $$C(u_t) = \\sum_{{x \\in \\{{CB1, CB2, Dep\\}}}} C_x(\\Delta_x, c_x)$$
   
   –≥–¥–µ $C_x(\\Delta_x, c_x)$ - —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∞–∫—Ç–∏–≤–æ–º $x$ —Å –∫–æ–º–∏—Å—Å–∏–µ–π $c_x$.

2. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è:**
   $$s_{{t+1}} = \\omega_t \\odot s'_t$$
   
   –≥–¥–µ $\\odot$ - –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä–æ–≤):
   $$s_{{t+1}} = (s'_{{CB1}} \\cdot \\omega_{{CB1}}, s'_{{CB2}} \\cdot \\omega_{{CB2}}, s'_{{Dep}} \\cdot \\omega_{{Dep}}, c'_{{t}})$$
   
   –≥–¥–µ $s'_{{CB1}}, s'_{{CB2}}, s'_{{Dep}}$ - —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–æ–≤ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è, $\\omega_{{CB1}}, \\omega_{{CB2}}, \\omega_{{Dep}}$ - –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏—è, $c'_{{t}}$ - –∫–∞—Å—Å–∞ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è.

#### –†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏

–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ ($\\Delta > 0$):
$$C(\\Delta, c) = \\Delta \\cdot (1 + c)$$

–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ ($\\Delta < 0$):
$$C(\\Delta, c) = |\\Delta| \\cdot (1 - c)$$

–≥–¥–µ $C(\\Delta, c)$ - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏, $\\Delta$ - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∞, $c$ - –∫–æ–º–∏—Å—Å–∏—è.

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–ö–∞—Å—Å–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:**
$$\\sum_{{x}} C_x(\\Delta_x, c_x) \\leq c_t$$

–≥–¥–µ $c_t$ - –∫–∞—Å—Å–∞ –Ω–∞ —ç—Ç–∞–ø–µ $t$.

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º:**
$$s_{{CB1}} \\geq s_{{CB1}}^{{\\min}}, \\quad s_{{CB2}} \\geq s_{{CB2}}^{{\\min}}, \\quad s_{{Dep}} \\geq s_{{Dep}}^{{\\min}}$$

**–ù–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞—Å—Å—ã:**
$$c_{{t+1}} \\geq 0$$

–≥–¥–µ $c_{{t+1}}$ - –∫–∞—Å—Å–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —ç—Ç–∞–ø–µ $t$.

### 3.2 –ü—Ä–æ—Ü–µ—Å—Å DP

![–ü—Ä–æ—Ü–µ—Å—Å DP](diagrams/03_dp_process.png)

*–†–∏—Å. 3.1 - –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è DP*

### 3.3 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —ç—Ç–∞–ø–∞–º
        if timing_data:
            report += "| –≠—Ç–∞–ø | –ö–æ–ª-–≤–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π | –í—Ä–µ–º—è (—Å–µ–∫) | –õ—É—á—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |\n"
            report += "|------|------------------|-------------|-----------------|\n"
            for stage in sorted(solver.value_function.keys()):
                num_states = len(solver.value_function[stage])
                time_val = timing_data.get(stage, 0)
                best_value = max(solver.value_function[stage].values()) if solver.value_function[stage] else 0
                report += f"| {stage} | {num_states} | {time_val:.2f} | {best_value:.2f} –¥.–µ. |\n"
        else:
            report += "| –≠—Ç–∞–ø | –ö–æ–ª-–≤–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π | –õ—É—á—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |\n"
            report += "|------|------------------|-----------------|\n"
            for stage in sorted(solver.value_function.keys()):
                num_states = len(solver.value_function[stage])
                best_value = max(solver.value_function[stage].values()) if solver.value_function[stage] else 0
                report += f"| {stage} | {num_states} | {best_value:.2f} –¥.–µ. |\n"
        
        report += f"""

---

## –≠—Ç–∞–ø 4: –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 4.1 –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

![–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è](diagrams/04_optimal_actions.png)

*–†–∏—Å. 4.1 - –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ*

### 4.2 –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—à–µ–Ω–∏–π

| –≠—Ç–∞–ø | –¶–ë1 (–¥.–µ.) | –¶–ë2 (–¥.–µ.) | –î–µ–ø (–¥.–µ.) | –û–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥ |
|------|------------|------------|------------|----------------|
"""
        
        for i, action in enumerate(actions, 1):
            delta_cb1, delta_cb2, delta_dep = action
            expected_val = solver.value_function[1].get(
                solver._find_closest_state(initial_portfolio, 1), total_value
            ) if i == 1 else 0
            report += f"| {i} | {delta_cb1:+.2f} | {delta_cb2:+.2f} | {delta_dep:+.2f} | {expected_val:.2f} –¥.–µ. |\n"
        
        report += f"""

### 4.3 –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏–π

–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞. –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∑–Ω–∞—á–∞—é—Ç –ø–æ–∫—É–ø–∫—É, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ - –ø—Ä–æ–¥–∞–∂—É.

---

## –≠—Ç–∞–ø 5: –≠–≤–æ–ª—é—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è

### 5.1 –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è

![–≠–≤–æ–ª—é—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è](diagrams/05_portfolio_evolution.png)

*–†–∏—Å. 5.1 - –≠–≤–æ–ª—é—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ —ç—Ç–∞–ø–∞–º*

### 5.2 –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
        for i, portfolio in enumerate(path):
            if i % 2 == 0:
                stage_num = i // 2
                report += f"**–≠—Ç–∞–ø {stage_num} (—Å–æ—Å—Ç–æ—è–Ω–∏–µ):**\n\n"
                report += f"- –¶–ë1: {portfolio.cb1:.2f} –¥.–µ.\n"
                report += f"- –¶–ë2: {portfolio.cb2:.2f} –¥.–µ.\n"
                report += f"- –î–µ–ø–æ–∑–∏—Ç—ã: {portfolio.dep:.2f} –¥.–µ.\n"
                report += f"- –ö–∞—Å—Å–∞: {portfolio.cash:.2f} –¥.–µ.\n"
                report += f"- **–ò—Ç–æ–≥–æ: {portfolio.total_value():.2f} –¥.–µ.**\n\n"
        
        report += f"""

---

## –≠—Ç–∞–ø 6: Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è

### 6.1 –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏

![MC —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ](diagrams/06_monte_carlo_distribution.png)

*–†–∏—Å. 6.1 - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤ –ø—Ä–∏ 5000 —Å–∏–º—É–ª—è—Ü–∏—è—Ö*

### 6.2 CDF (Cumulative Distribution Function)

![MC CDF](diagrams/06_monte_carlo_cdf.png)

*–†–∏—Å. 6.2 - –ö—É–º—É–ª—è—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤*

### 6.3 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –û–∂–∏–¥–∞–Ω–∏–µ ($\mu$) | {mc_results.get('mean', 0):.2f} –¥.–µ. |
| –°—Ç–¥.–æ—Ç–∫–ª ($\sigma$) | {mc_results.get('std', 0):.2f} –¥.–µ. |
| –ú–∏–Ω–∏–º—É–º | {mc_results.get('min', 0):.2f} –¥.–µ. |
| –ú–∞–∫—Å–∏–º—É–º | {mc_results.get('max', 0):.2f} –¥.–µ. |

–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:

$$\\mu = \\frac{{1}}{{N}}\\sum_{{i=1}}^{{N}} X_i, \\quad \\sigma = \\sqrt{{\\frac{{1}}{{N-1}}\\sum_{{i=1}}^{{N}}(X_i - \\mu)^2}}$$

–≥–¥–µ $N = 5000$ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º—É–ª—è—Ü–∏–π, $X_i$ - –¥–æ—Ö–æ–¥ –≤ $i$-–π —Å–∏–º—É–ª—è—Ü–∏–∏.

### 6.4 –í—ã–≤–æ–¥—ã

Monte Carlo —Å–∏–º—É–ª—è—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è. –û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ $\\mu$ –±–ª–∏–∑–∫–æ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

---

## –≠—Ç–∞–ø 7: –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 7.1 –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º

![–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º](diagrams/07_sensitivity_probabilities.png)

*–†–∏—Å. 7.1 - –í–ª–∏—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –Ω–∞ –¥–æ—Ö–æ–¥*

### 7.2 –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∫–æ–º–∏—Å—Å–∏—è–º

![–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∫–æ–º–∏—Å—Å–∏—è–º](diagrams/07_sensitivity_commissions.png)

*–†–∏—Å. 7.2 - –í–ª–∏—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ –¥–æ—Ö–æ–¥*

### 7.3 –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

–ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É—Å—Ç–æ–π—á–∏–≤–æ —Ä–µ—à–µ–Ω–∏–µ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–¥–∞—á–∏.

---

## –≠—Ç–∞–ø 8: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤

### 8.1 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

![–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤](diagrams/08_criteria_comparison.png)

*–†–∏—Å. 8.1 - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤*

### 8.2 –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ (–¥.–µ.) | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ë–∞–π–µ—Å–∞ |
|----------|--------------------------|---------------------|
"""
        
        bayesian_value = criteria_results.get('–ë–∞–π–µ—Å', total_value)
        for criterion, value in criteria_results.items():
            relative = ((value - bayesian_value) / bayesian_value * 100) if bayesian_value > 0 else 0
            report += f"| {criterion} | {value:.2f} | {relative:+.2f}% |\n"
        
        report += f"""

---

## –≠—Ç–∞–ø 9: 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

### 9.1 3D –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏

![3D —Ñ—É–Ω–∫—Ü–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏](diagrams/09_3d_value_function.png)

*–†–∏—Å. 9.1 - –¢—Ä–µ—Ö–º–µ—Ä–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏*

### 9.2 –ê–Ω–∞–ª–∏–∑ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏

3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –æ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ.

---

## –≠—Ç–∞–ø 10: –î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π

### 10.1 –ü–æ–ª–Ω–æ–µ –¥–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π

![–î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π](diagrams/10_decision_tree.png)

*–†–∏—Å. 10.1 - –ì—Ä–∞—Ñ –¥–µ—Ä–µ–≤–∞ —Ä–µ—à–µ–Ω–∏–π —Å–æ –≤—Å–µ–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏*

### 10.2 –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å

–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ –¥–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π –≤—ã–¥–µ–ª–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –¥–µ–π—Å—Ç–≤–∏–π, –≤–µ–¥—É—â–∏—Ö –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É –¥–æ—Ö–æ–¥—É.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥:** {total_value:.2f} –¥.–µ.
2. **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:** 
"""
        
        for i, action in enumerate(actions, 1):
            delta_cb1, delta_cb2, delta_dep = action
            report += f"   - –≠—Ç–∞–ø {i}: –¶–ë1={delta_cb1:+.2f}, –¶–ë2={delta_cb2:+.2f}, –î–µ–ø={delta_dep:+.2f}\n"
        
        report += f"""
3. **–†–∏—Å–∫:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = {mc_results.get('std', 0):.2f} –¥.–µ.
4. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è

### –í—ã–≤–æ–¥—ã:

1. –ê–ª–≥–æ—Ä–∏—Ç–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º.
2. –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π {'—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–ª–∏—è–µ—Ç' if USE_COMMISSIONS else '–Ω–µ –≤–ª–∏—è–µ—Ç'} –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.
3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º {'–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç' if USE_MIN_CONSTRAINTS else '–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç'} –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ä–µ—à–µ–Ω–∏–π.
4. –°—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∑–∞–¥–∞—á–∏ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤.

### –ß—Ç–æ –¥–∞–ª—å—à–µ:

–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç—Ç–∞–ø–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –£—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∏–∑–¥–µ—Ä–∂–µ–∫
- –ú–Ω–æ–≥–æ—Ü–µ–ª–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–¥–æ—Ö–æ–¥ vs —Ä–∏—Å–∫)

---

## –ö–æ–¥ —Ä–µ—à–µ–Ω–∏—è

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

\`\`\`
lab4/
‚îú‚îÄ‚îÄ constants.py              # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îú‚îÄ‚îÄ models.py                 # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ data_loader.py            # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ solver.py                 # –†–µ—à–∞—Ç–µ–ª—å DP
‚îú‚îÄ‚îÄ path_recovery.py          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏
‚îú‚îÄ‚îÄ visualizers.py            # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ data_exporter.py          # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ sensitivity_analysis.py   # –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ criteria_comparison.py     # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
‚îú‚îÄ‚îÄ generate_report.py        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
‚îú‚îÄ‚îÄ main.py                   # –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
‚îî‚îÄ‚îÄ output/                   # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    ‚îú‚îÄ‚îÄ report.md            # –û—Ç—á–µ—Ç
    ‚îú‚îÄ‚îÄ diagrams/            # –ì—Ä–∞—Ñ–∏–∫–∏
    ‚îî‚îÄ‚îÄ data/               # CSV –¥–∞–Ω–Ω—ã–µ
\`\`\`

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã

\`\`\`bash
python main.py
\`\`\`

–∏–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:

\`\`\`bash
python generate_report.py
\`\`\`
"""
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(report)
        
        logger.info(f"–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {filepath}")
        return str(filepath)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {e}")
        raise


def create_readme() -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç README.md –¥–ª—è GitHub
    
    Returns:
        –ü—É—Ç—å –∫ README.md
    """
    filepath = Path('README.md')
    
    try:
        readme_content = f"""# Dynamic Programming Portfolio Optimization

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ—Ä—Ç—Ñ–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö –≤–∏–¥–æ–≤ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥ –∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–∞ 3 —ç—Ç–∞–ø–∞—Ö —Å —É—á–µ—Ç–æ–º —Å—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞–∑–≤–∏—Ç–∏—è —Ä—ã–Ω–∫–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ [output/report.md](output/report.md)
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è (5000 —Å–∏–º—É–ª—è—Ü–∏–π)
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** 10 —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –¥–∏–∞–≥—Ä–∞–º–º

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- `output/report.md` - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º
- `output/diagrams/` - –í—Å–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏ (PNG, 150 DPI)
- `output/data/` - CSV —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
- –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

\`\`\`bash
pip install -r requirements.txt
\`\`\`

### –ó–∞–ø—É—Å–∫ —Ä–µ—à–µ–Ω–∏—è

\`\`\`bash
python main.py
\`\`\`

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞

\`\`\`bash
python generate_report.py
\`\`\`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

\`\`\`
lab4/
‚îú‚îÄ‚îÄ constants.py              # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ models.py                 # –ö–ª–∞—Å—Å—ã Portfolio, Scenario, Decision
‚îú‚îÄ‚îÄ data_loader.py            # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel
‚îú‚îÄ‚îÄ solver.py                 # –†–µ—à–∞—Ç–µ–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ path_recovery.py          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ visualizers.py            # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (10 —Ñ—É–Ω–∫—Ü–∏–π)
‚îú‚îÄ‚îÄ data_exporter.py          # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV
‚îú‚îÄ‚îÄ sensitivity_analysis.py   # –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ criteria_comparison.py     # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
‚îú‚îÄ‚îÄ generate_report.py        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Markdown –æ—Ç—á–µ—Ç–∞
‚îú‚îÄ‚îÄ main.py                   # –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ test_commissions.py       # –¢–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ requirements.txt          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ output/                   # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    ‚îú‚îÄ‚îÄ report.md            # –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
    ‚îú‚îÄ‚îÄ diagrams/            # –ì—Ä–∞—Ñ–∏–∫–∏ (PNG)
    ‚îî‚îÄ‚îÄ data/                # CSV –¥–∞–Ω–Ω—ã–µ
\`\`\`

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –±—Ä–æ–∫–µ—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –∞–∫—Ç–∏–≤–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (10 —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤)
- –ü–æ–ª–Ω—ã–π Markdown –æ—Ç—á–µ—Ç —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª–µ `constants.py`:

- `USE_COMMISSIONS` - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–æ–º–∏—Å—Å–∏–∏
- `USE_MIN_CONSTRAINTS` - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∏–Ω–∏–º—É–º
- `INITIAL_CASH` - –Ω–∞—á–∞–ª—å–Ω–∞—è –∫–∞—Å—Å–∞

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [algorithm_pseudocode.md](algorithm_pseudocode.md) - –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
- [class_diagram.md](class_diagram.md) - –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤
- [examples.md](examples.md) - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
- [output/report.md](output/report.md) - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

## –õ–∏—Ü–µ–Ω–∑–∏—è

–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–∞ "–ú–µ—Ç–æ–¥—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏".

---

*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {datetime.now().strftime('%Y-%m-%d')}*  
*–í–µ—Ä—Å–∏—è: 1.0*
"""
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(readme_content)
        
        logger.info(f"README.md —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω: {filepath}")
        return str(filepath)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ README: {e}")
        raise


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    """
    print("=" * 70)
    print("–ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–û–õ–ù–û–ì–û –û–¢–ß–ï–¢–ê –° –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ï–ô")
    print("=" * 70)
    
    timing_data = {}
    
    try:
        # 1. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        print("\n[1/8] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫...")
        create_report_structure()
        
        # 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        print("\n[2/8] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
        excel_file = "–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–¥–∞—á–∏.xlsx"
        import os
        if os.path.exists(excel_file):
            scenarios, commissions, initial_cash = load_from_excel(excel_file)
        else:
            from constants import SCENARIOS, COMMISSIONS, INITIAL_CASH
            scenarios = {}
            for stage, stage_data in SCENARIOS.items():
                scenarios[stage] = [
                    Scenario(
                        situation=item['situation'],
                        probability=item['probability'],
                        cb1_multiplier=item['cb1'],
                        cb2_multiplier=item['cb2'],
                        dep_multiplier=item['dep']
                    )
                    for item in stage_data
                ]
            commissions = COMMISSIONS.copy()
            initial_cash = INITIAL_CASH
        
        validate_scenarios(scenarios)
        initial_portfolio = initialize_portfolio(cash=initial_cash)
        
        # 3. –†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É DP
        print("\n[3/8] –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ DP...")
        start_time = time.time()
        solver = DynamicProgrammingSolver(
            initial_portfolio=initial_portfolio,
            scenarios=scenarios,
            commissions=commissions,
            use_commissions=USE_COMMISSIONS,
            use_min_constraints=USE_MIN_CONSTRAINTS
        )
        solver.solve_backward()
        elapsed = time.time() - start_time
        timing_data[1] = elapsed
        path, actions, total_value = solver.get_optimal_path()
        print(f"  –†–µ—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞ {elapsed:.2f} —Å–µ–∫")
        print(f"  –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥: {total_value:.2f} –¥.–µ.")
        
        # 4. Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è
        print("\n[4/8] Monte Carlo –≤–∞–ª–∏–¥–∞—Ü–∏—è (5000 —Å–∏–º—É–ª—è—Ü–∏–π)...")
        mc_results = monte_carlo_simulation(
            solver, initial_portfolio, scenarios,
            n_simulations=5000, random_seed=42
        )
        print(f"  –û–∂–∏–¥–∞–Ω–∏–µ: {mc_results['mean']:.2f} –¥.–µ.")
        
        # 5. –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        print("\n[5/8] –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...")
        sensitivity_results = run_full_sensitivity_analysis(
            initial_portfolio, scenarios, commissions,
            USE_COMMISSIONS, USE_MIN_CONSTRAINTS
        )
        print(f"  –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # 6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        print("\n[6/8] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤...")
        criteria_results = compare_all_criteria(
            initial_portfolio, scenarios, commissions,
            USE_COMMISSIONS, USE_MIN_CONSTRAINTS
        )
        print(f"  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        
        # 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π
        print("\n[7/8] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π...")
        diagram_paths = generate_all_visualizations(
            solver, initial_portfolio, scenarios, commissions,
            path, actions, mc_results, sensitivity_results, criteria_results, timing_data
        )
        print(f"  –°–æ–∑–¥–∞–Ω–æ {len(diagram_paths)} –≥—Ä–∞—Ñ–∏–∫–æ–≤")
        
        # 8. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        print("\n[8/9] –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV...")
        expected_values = None
        exported_files = export_all_data(
            actions, path, mc_results, sensitivity_results, expected_values
        )
        print(f"  –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(exported_files)} CSV —Ñ–∞–π–ª–æ–≤")
        
        # 9. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        print("\n[9/9] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Markdown –æ—Ç—á–µ—Ç–∞...")
        report_path = generate_markdown_report(
            solver, initial_portfolio, scenarios, commissions,
            path, actions, total_value, mc_results,
            sensitivity_results, criteria_results, diagram_paths, timing_data
        )
        print(f"  –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {report_path}")
        
        # 10. –°–æ–∑–¥–∞–Ω–∏–µ README
        print("\n[10/10] –°–æ–∑–¥–∞–Ω–∏–µ README...")
        readme_path = create_readme()
        print(f"  README —Å–æ–∑–¥–∞–Ω: {readme_path}")
        
        print("\n" + "=" * 70)
        print("–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!")
        print("=" * 70)
        print("\n–õ–æ–∫–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤:")
        print(f"  {report_path} - –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç—á–µ—Ç")
        print(f"  output/diagrams/ - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ (PNG)")
        print(f"  output/data/ - –¥–∞–Ω–Ω—ã–µ –≤ CSV")
        print(f"  {readme_path} - –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è GitHub")
        
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {e}")
        import traceback
        traceback.print_exc()
        raise


if __name__ == "__main__":
    main()
