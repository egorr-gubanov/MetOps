# Решение задачи динамического программирования: Оптимальное управление инвестиционным портфелем

## Оглавление

1. [Введение](#введение)
2. [Описание задачи](#описание-задачи)
3. [Этап 1: Инициализация](#этап-1-инициализация)
4. [Этап 2: Сценарии](#этап-2-сценарии)
5. [Этап 3: Динамическое программирование](#этап-3-динамическое-программирование)
6. [Этап 4: Оптимальные решения](#этап-4-оптимальные-решения)
7. [Этап 5: Эволюция портфеля](#этап-5-эволюция-портфеля)
8. [Этап 6: Monte Carlo валидация](#этап-6-monte-carlo-валидация)
9. [Этап 7: Анализ чувствительности](#этап-7-анализ-чувствительности)
10. [Этап 8: Сравнение критериев](#этап-8-сравнение-критериев)
11. [Этап 9: 3D визуализация](#этап-9-3d-визуализация)
12. [Этап 10: Дерево решений](#этап-10-дерево-решений)
13. [Заключение](#заключение)
14. [Код решения](#код-решения)

---

## Введение

Данная работа представляет решение задачи оптимального управления инвестиционным портфелем методом динамического программирования. Задача имеет стохастический характер, так как будущие доходы зависят от вероятностных сценариев развития рынка.

**Цель работы:** Найти оптимальную стратегию управления портфелем, максимизирующую ожидаемый доход за 3 этапа планирования.

**Метод решения:** Динамическое программирование с критерием Байеса (максимизация математического ожидания дохода).

---

## Описание задачи

### 2.1 Постановка задачи

Решить задачу оптимального управления инвестиционным портфелем с использованием метода динамического программирования. Портфель состоит из двух видов ценных бумаг (ЦБ1 и ЦБ2) и депозитов. Управление осуществляется путем покупки/продажи активов пакетами (25% от начального объема).

**Период планирования:** 3 этапа  
**Критерий оптимальности:** Максимизация ожидаемого дохода (критерий Байеса)  
**Особенности:** Учет комиссий брокеров и ограничений на минимальный объем активов

#### Математическая формулировка

**Состояние портфеля:**
$$s_t = (s_{CB1}, s_{CB2}, s_{Dep}, s_{cash}) \in \mathbb{R}^4_+$$

**Управление:**
$$u_t = (\Delta_{CB1}, \Delta_{CB2}, \Delta_{Dep}) \in \mathbb{R}^3$$

**Целевая функция (критерий Байеса):**
$$\max \mathbb{E}[J_1(s_1)] = \max \mathbb{E}\left[\sum_{t=1}^{T} r_t(s_t, u_t)\right]$$

где $r_t$ - доход на этапе $t$, $T=3$ - количество этапов.

### 2.2 Исходные данные

| Параметр | Значение |
|----------|----------|
| Начальная стоимость ЦБ1 | 100.00 д.е. |
| Начальная стоимость ЦБ2 | 800.00 д.е. |
| Начальная стоимость Депозитов | 400.00 д.е. |
| Начальная касса | 600.00 д.е. |
| **Итого начальный капитал** | **1900.00 д.е.** |
| Комиссия ЦБ1 | 4.0% (включена) |
| Комиссия ЦБ2 | 7.0% (включена) |
| Комиссия Депозитов | 5.0% (включена) |
| Минимум ЦБ1 | 30.00 д.е. (включен) |
| Минимум ЦБ2 | 150.00 д.е. (включен) |
| Минимум Депозитов | 100.00 д.е. (включен) |

### 2.3 Сценарии развития

На каждом этапе возможны три сценария: благоприятный, нейтральный и негативный. Вероятности и мультипликаторы для каждого этапа представлены в таблице ниже.

#### ЭТАП 1 (Период 0→1):

| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|----------|-------------|-----|-----|------|
| благоприятная | 0.60 | 1.20 | 1.10 | 1.07 |
| нейтральная | 0.30 | 1.05 | 1.02 | 1.03 |
| негативная | 0.10 | 0.80 | 0.95 | 1.00 |

#### ЭТАП 2 (Период 1→2):

| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|----------|-------------|-----|-----|------|
| благоприятная | 0.30 | 1.40 | 1.15 | 1.01 |
| нейтральная | 0.20 | 1.05 | 1.00 | 1.00 |
| негативная | 0.50 | 0.60 | 0.90 | 1.00 |

#### ЭТАП 3 (Период 2→3):

| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|----------|-------------|-----|-----|------|
| благоприятная | 0.40 | 1.15 | 1.12 | 1.05 |
| нейтральная | 0.40 | 1.05 | 1.01 | 1.01 |
| негативная | 0.20 | 0.70 | 0.94 | 1.00 |


---

## Этап 1: Инициализация

### 1.1 Начальное состояние портфеля

Начальный портфель распределен следующим образом:
- **ЦБ1:** 100.00 д.е. (5.3%)
- **ЦБ2:** 800.00 д.е. (42.1%)
- **Депозиты:** 400.00 д.е. (21.1%)
- **Касса:** 600.00 д.е. (31.6%)
- **Итого:** 1900.00 д.е.

![Начальный портфель](diagrams/01_initial_portfolio.png)

*Рис. 1.1 - Распределение начального портфеля*

### 1.2 Параметры задачи

Все параметры задачи представлены в таблице на графике выше.

---

## Этап 2: Сценарии

### 2.1 Матрица сценариев

![Матрица сценариев](diagrams/02_scenarios_matrix.png)

*Рис. 2.1 - Тепловая карта сценариев и вероятностей*

### 2.2 Дерево сценариев

![Дерево сценариев](diagrams/02_scenario_tree.png)

*Рис. 2.2 - Граф дерева сценариев*

### 2.3 Анализ сценариев

На каждом этапе присутствуют три сценария с различными вероятностями. Сумма вероятностей для каждого этапа равна 1.0, что обеспечивает корректность вероятностной модели.

---

## Этап 3: Динамическое программирование

### 3.1 Математическая модель

#### Рекуррентное соотношение Беллмана

Основное уравнение динамического программирования:

$$J_t(s_t) = \max_{u_t \in U_t(s_t)} \mathbb{E}_{\omega_t}[J_{t+1}(s_{t+1}(s_t, \omega_t, u_t))]$$

Граничное условие:

$$J_T(s_T) = V(s_T)$$

где $V(s_T)$ - полная стоимость портфеля в состоянии $s_T$.

где:
- $J_t(s_t)$ - функция ценности состояния $s_t$ на этапе $t$
- $u_t$ - управление (действие) на этапе $t$
- $\omega_t$ - реализованный сценарий на этапе $t$
- $\mathbb{E}_{\omega_t}[\cdot]$ - математическое ожидание по сценариям
- $U_t(s_t)$ - множество допустимых управлений для состояния $s_t$

#### Уравнение перехода состояний

После применения управления $u_t = (\Delta_{CB1}, \Delta_{CB2}, \Delta_{Dep})$ и реализации сценария $\omega_t$:

$$s_{t+1} = f(s_t, u_t, \omega_t)$$

где функция перехода включает:

1. **Применение действия:**
   $$s'_t = s_t + u_t - C(u_t)$$
   
   где $C(u_t)$ - эффективная стоимость действия с учетом комиссий:
   $$C(u_t) = \sum_{x \in \{CB1, CB2, Dep\}} C_x(\Delta_x, c_x)$$
   
   где $C_x(\Delta_x, c_x)$ - стоимость операции с активом $x$ с комиссией $c_x$.

2. **Применение сценария:**
   $$s_{t+1} = \omega_t \odot s'_t$$
   
   где $\odot$ - поэлементное умножение (применение мультипликаторов):
   $$s_{t+1} = (s'_{CB1} \cdot \omega_{CB1}, s'_{CB2} \cdot \omega_{CB2}, s'_{Dep} \cdot \omega_{Dep}, c'_{t})$$
   
   где $s'_{CB1}, s'_{CB2}, s'_{Dep}$ - стоимости активов после действия, $\omega_{CB1}, \omega_{CB2}, \omega_{Dep}$ - мультипликаторы сценария, $c'_{t}$ - касса после действия.

#### Расчет эффективной стоимости

При покупке ($\Delta > 0$):
$$C(\Delta, c) = \Delta \cdot (1 + c)$$

При продаже ($\Delta < 0$):
$$C(\Delta, c) = |\Delta| \cdot (1 - c)$$

где $C(\Delta, c)$ - эффективная стоимость операции, $\Delta$ - изменение стоимости актива, $c$ - комиссия.

#### Ограничения

**Кассовое ограничение:**
$$\sum_{x} C_x(\Delta_x, c_x) \leq c_t$$

где $c_t$ - касса на этапе $t$.

**Ограничения на минимальный объем:**
$$s_{CB1} \geq s_{CB1}^{\min}, \quad s_{CB2} \geq s_{CB2}^{\min}, \quad s_{Dep} \geq s_{Dep}^{\min}$$

**Неотрицательность кассы:**
$$c_{t+1} \geq 0$$

где $c_{t+1}$ - касса после выполнения действия на этапе $t$.

### 3.2 Процесс DP

![Процесс DP](diagrams/03_dp_process.png)

*Рис. 3.1 - Процесс обратного прохождения DP*

### 3.3 Статистика вычислений

| Этап | Кол-во состояний | Время (сек) | Лучшее значение |
|------|------------------|-------------|-----------------|
| 1 | 432 | 0.30 | 2184.12 д.е. |
| 2 | 0 | 0.00 | 0.00 д.е. |
| 3 | 0 | 0.00 | 0.00 д.е. |


---

## Этап 4: Оптимальные решения

### 4.1 Оптимальные действия

![Оптимальные действия](diagrams/04_optimal_actions.png)

*Рис. 4.1 - Оптимальные действия на каждом этапе*

### 4.2 Таблица решений

| Этап | ЦБ1 (д.е.) | ЦБ2 (д.е.) | Деп (д.е.) | Ожидаемый доход |
|------|------------|------------|------------|----------------|
| 1 | +75.00 | +0.00 | +200.00 | 2021.69 д.е. |
| 2 | +0.00 | +0.00 | +0.00 | 0.00 д.е. |
| 3 | +0.00 | +0.00 | +0.00 | 0.00 д.е. |


### 4.3 Интерпретация решений

Оптимальная стратегия показывает, какие действия необходимо предпринять на каждом этапе для максимизации ожидаемого дохода. Положительные значения означают покупку, отрицательные - продажу.

---

## Этап 5: Эволюция портфеля

### 5.1 Изменение портфеля

![Эволюция портфеля](diagrams/05_portfolio_evolution.png)

*Рис. 5.1 - Эволюция портфеля по этапам*

### 5.2 Поэтапное описание

**Этап 0 (состояние):**

- ЦБ1: 100.00 д.е.
- ЦБ2: 800.00 д.е.
- Депозиты: 400.00 д.е.
- Касса: 600.00 д.е.
- **Итого: 1900.00 д.е.**

**Этап 1 (состояние):**

- ЦБ1: 195.12 д.е.
- ЦБ2: 848.80 д.е.
- Депозиты: 630.60 д.е.
- Касса: 312.00 д.е.
- **Итого: 1986.52 д.е.**

**Этап 2 (состояние):**

- ЦБ1: 181.47 д.е.
- ЦБ2: 844.56 д.е.
- Депозиты: 632.49 д.е.
- Касса: 312.00 д.е.
- **Итого: 1970.51 д.е.**



---

## Этап 6: Monte Carlo валидация

### 6.1 Результаты симуляции

![MC распределение](diagrams/06_monte_carlo_distribution.png)

*Рис. 6.1 - Распределение доходов при 5000 симуляциях*

### 6.2 CDF (Cumulative Distribution Function)

![MC CDF](diagrams/06_monte_carlo_cdf.png)

*Рис. 6.2 - Кумулятивное распределение доходов*

### 6.3 Статистика результатов

| Метрика | Значение |
|---------|----------|
| Ожидание ($\mu$) | 1969.82 д.е. |
| Стд.откл ($\sigma$) | 178.90 д.е. |
| Минимум | 1680.00 д.е. |
| Максимум | 2266.42 д.е. |

Статистические характеристики:

$$\mu = \frac{1}{N}\sum_{i=1}^{N} X_i, \quad \sigma = \sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(X_i - \mu)^2}$$

где $N = 5000$ - количество симуляций, $X_i$ - доход в $i$-й симуляции.

### 6.4 Выводы

Monte Carlo симуляция подтверждает корректность решения. Ожидаемое значение $\mu$ близко к результату динамического программирования, что подтверждает оптимальность найденной стратегии.

---

## Этап 7: Анализ чувствительности

### 7.1 Чувствительность к вероятностям

![Чувствительность к вероятностям](diagrams/07_sensitivity_probabilities.png)

*Рис. 7.1 - Влияние изменения вероятностей на доход*

### 7.2 Чувствительность к комиссиям

![Чувствительность к комиссиям](diagrams/07_sensitivity_commissions.png)

*Рис. 7.2 - Влияние изменения комиссий на доход*

### 7.3 Интерпретация

Анализ чувствительности показывает, насколько устойчиво решение к изменениям параметров задачи.

---

## Этап 8: Сравнение критериев

### 8.1 Сравнение критериев принятия решений

![Сравнение критериев](diagrams/08_criteria_comparison.png)

*Рис. 8.1 - Сравнение результатов для разных критериев*

### 8.2 Таблица сравнения

| Критерий | Оптимальный доход (д.е.) | Относительно Байеса |
|----------|--------------------------|---------------------|
| Байес | 2021.69 | +0.00% |
| Вальд | 179.00 | -91.15% |
| Сэвидж | 2072.56 | +2.52% |


---

## Этап 9: 3D визуализация

### 9.1 3D поверхность функции ценности

![3D функция ценности](diagrams/09_3d_value_function.png)

*Рис. 9.1 - Трехмерная визуализация функции ценности*

### 9.2 Анализ оптимальной области

3D визуализация показывает зависимость максимального дохода от распределения активов в портфеле.

---

## Этап 10: Дерево решений

### 10.1 Полное дерево решений

![Дерево решений](diagrams/10_decision_tree.png)

*Рис. 10.1 - Граф дерева решений со всеми состояниями и действиями*

### 10.2 Оптимальный путь

Оптимальный путь через дерево решений выделен и показывает последовательность состояний и действий, ведущих к максимальному ожидаемому доходу.

---

## Заключение

### Основные результаты:

1. **Максимальный ожидаемый доход:** 2021.69 д.е.
2. **Оптимальные действия:** 
   - Этап 1: ЦБ1=+75.00, ЦБ2=+0.00, Деп=+200.00
   - Этап 2: ЦБ1=+0.00, ЦБ2=+0.00, Деп=+0.00
   - Этап 3: ЦБ1=+0.00, ЦБ2=+0.00, Деп=+0.00

3. **Риск:** Стандартное отклонение = 178.90 д.е.
4. **Стабильность:** Monte Carlo валидация подтверждает корректность решения

### Выводы:

1. Алгоритм динамического программирования успешно находит оптимальную стратегию управления портфелем.
2. Учет комиссий существенно влияет на оптимальные решения.
3. Ограничения на минимальный объем ограничивают пространство допустимых решений.
4. Стохастический характер задачи требует использования вероятностных критериев.

### Что дальше:

Возможные улучшения:
- Увеличение количества этапов планирования
- Более детальная дискретизация пространства состояний
- Учет транзакционных издержек
- Многоцелевая оптимизация (доход vs риск)

---

## Код решения

### Файловая структура проекта

\`\`\`
lab4/
├── constants.py              # Константы
├── models.py                 # Модели данных
├── data_loader.py            # Загрузка данных
├── solver.py                 # Решатель DP
├── path_recovery.py          # Восстановление пути
├── visualizers.py            # Визуализация
├── data_exporter.py          # Экспорт данных
├── sensitivity_analysis.py   # Анализ чувствительности
├── criteria_comparison.py     # Сравнение критериев
├── generate_report.py        # Генерация отчета
├── main.py                   # Главный скрипт
└── output/                   # Результаты
    ├── report.md            # Отчет
    ├── diagrams/            # Графики
    └── data/               # CSV данные
\`\`\`

### Запуск программы

\`\`\`bash
python main.py
\`\`\`

или для генерации полного отчета:

\`\`\`bash
python generate_report.py
\`\`\`
